<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiniela 360 - Login</title>
  <style>
    body {
        font-family: 'Arial', sans-serif;
        background-image: url('https://images.unsplash.com/photo-1569337042150-c21c85b80a10?q=80&w=1540&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }
    .login-container {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      width: 350px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    h1 {
      color: #006847;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button, #google-login {
      width: 100%;
      padding: 12px;
      background: #006847;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }
    button:hover, #google-login:hover {
      background: #004d33;
    }
    #form-message {
      margin-top: 1rem;
      padding: 10px;
      border-radius: 5px;
      display: none;
      text-align: center;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .register-link {
      text-align: center;
      margin-top: 1.5rem;
    }
    .register-link a {
      color: #006847;
      text-decoration: none;
      font-weight: 500;
    }
    .divider {
      text-align: center;
      margin: 1.5rem 0;
      position: relative;
    }
    .divider::before,
    .divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #ccc;
    }
    .divider::before {
      left: 0;
    }
    .divider::after {
      right: 0;
    }
  </style>
</head>
<body>
 
  <div class="login-container">
    <h1>Quiniela 360<img src="img/hidra.png" width="40"></h1>

    <!-- Formulario de login por correo -->
    <form id="login-form">
   <div class="form-group">
     <!--    <label for="email">Correo electrÃ³nico</label>
        <input type="email" id="email" required>
      </div>
       <div class="form-group">
        <label for="password">ContraseÃ±a</label>
        <input type="password" id="password" required>
      </div>
   <button type="submit">Iniciar sesiÃ³n</button>
      <div id="form-message" class="error"></div>
    </form> 

    <!-- DivisiÃ³n -->
    <div class="divider">o</div>

    <!-- BotÃ³n de login con Google -->
    <button id="google-login" style="background-color: #4285F4; color: white; font-weight: bold; border: none; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 10px; border-radius: 5px;">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/2048px-Google_%22G%22_logo.svg.png" alt="Google" style="width: 20px; height: 20px;">
      Entrar con Google
    </button>

    <!-- Enlace de registro -->
    <div class="register-link">
      Â¿No tienes cuenta? <a href="login.html">RegÃ­strate aquÃ­</a>
    </div>
  </div>

  <h2>ðŸ“° Ãšltimas Noticias de FÃºtbol</h2>
  <div id="noticias">Cargando noticias...</div>

  <h2>âš½ Tabla General - Ejemplo</h2>
  <table id="tablaGeneral">
    <thead>
      <tr>
        <th>Pos</th>
        <th>Equipo</th>
        <th>Pts</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

      
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

  <!-- ConfiguraciÃ³n de Firebase -->
  <script src="js/firebase-config.js"></script>

  <!-- LÃ³gica de autenticaciÃ³n -->
  <script>
const db = firebase.firestore();

// Detectar parÃ¡metro ref del URL (ID del invitador)
const urlParams = new URLSearchParams(window.location.search);
const referrerId = urlParams.get("ref"); // ðŸ”¹ Cambio realizado
console.log("ðŸŽ¯ Referrer detectado desde URL:", referrerId);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOGIN POR CORREO/PASSWORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const messageDiv = document.getElementById('form-message');

  try {
    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
    const user = userCredential.user;

    // Guardar usuario en Firestore si es nuevo
    const userRef = db.collection('users').doc(user.uid);
    const doc = await userRef.get();
    if (!doc.exists) {
      await userRef.set({
        uid: user.uid,
        creditos: 1,
        name: user.displayName || null,
        email: user.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // ðŸ‘‰ Enviar crÃ©dito al invitador (si hay referrerId)
      if (referrerId && referrerId !== user.uid) { // ðŸ”¹ Previene auto-crÃ©ditos
        try {
          const res = await fetch("https://quiniela-hydra.onrender.com/credit-invite", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ referrerId, invitedUserId: user.uid }),
          });
          const data = await res.json();
          console.log("ðŸ“¤ Request al backend enviado con referrerId:", referrerId);
          console.log("ðŸ“¥ Respuesta del backend:", data);
        } catch (err) {
          console.error("âŒ Error enviando crÃ©ditos de invitaciÃ³n:", err);
        }
      }
    }

    window.location.href = "interfaz.html";
  } catch (error) {
    let errorMessage;
    switch(error.code) {
      case 'auth/invalid-email':
        errorMessage = 'Correo electrÃ³nico invÃ¡lido';
        break;
      case 'auth/user-not-found':
        errorMessage = 'Usuario no registrado';
        break;
      case 'auth/wrong-password':
        errorMessage = 'ContraseÃ±a incorrecta';
        break;
      case 'auth/too-many-requests':
        errorMessage = 'Demasiados intentos. Intenta mÃ¡s tarde.';
        break;
      default:
        errorMessage = 'Error al iniciar sesiÃ³n';
    }

    messageDiv.textContent = errorMessage;
    messageDiv.style.display = 'block';
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOGIN CON GOOGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('google-login').addEventListener('click', async () => {
  const provider = new firebase.auth.GoogleAuthProvider();

  try {
    const result = await firebase.auth().signInWithPopup(provider);
    const user = result.user;

    // Guardar usuario en Firestore si es nuevo
    const userRef = db.collection('users').doc(user.uid);
    const doc = await userRef.get();
    if (!doc.exists) {
      await userRef.set({
        uid: user.uid,
        creditos: 1,
        name: user.displayName || null,
        email: user.email,
        photoURL: user.photoURL || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // ðŸ‘‰ Enviar crÃ©dito al invitador (si hay referrerId)
      if (referrerId && referrerId !== user.uid) { // ðŸ”¹ Previene auto-crÃ©ditos
        try {
          const res = await fetch("https://quiniela-hydra.onrender.com/credit-invite", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ referrerId, invitedUserId: user.uid }),
          });
          const data = await res.json();
          console.log("ðŸ“¤ Request al backend enviado con referrerId:", referrerId);
          console.log("ðŸ“¥ Respuesta del backend:", data);
        } catch (err) {
          console.error("âŒ Error enviando crÃ©ditos de invitaciÃ³n:", err);
        }
      }
    }

    window.location.href = "interfaz.html";
  } catch (error) {
    alert("Error al iniciar sesiÃ³n con Google: " + error.message);
  }
});


    // â”€â”€â”€â”€â”€ Noticias automÃ¡ticas desde RSS â”€â”€â”€â”€â”€
    async function cargarNoticias() {
      const rssUrl = 'https://www.espn.com.mx/espn/rss/news';
      const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`);
      const data = await response.json();
      const parser = new DOMParser();
      const xml = parser.parseFromString(data.contents, "text/xml");
      const items = xml.querySelectorAll("item");
      let html = '';
      items.forEach((item, index) => {
        if (index < 5) { // muestra solo 5
          html += `
            <div>
              <h3>${item.querySelector("title").textContent}</h3>
              <p><a href="${item.querySelector("link").textContent}" target="_blank">Ver noticia completa</a></p>
            </div><hr>`;
        }
      });
      document.getElementById("noticias").innerHTML = html;
    }

    // â”€â”€â”€â”€â”€ Tabla de posiciones (ejemplo local) â”€â”€â”€â”€â”€
    const equipos = [
      {pos: 1, nombre: "AmÃ©rica", pts: 35},
      {pos: 2, nombre: "Tigres", pts: 32},
      {pos: 3, nombre: "Monterrey", pts: 30},
      {pos: 4, nombre: "Toluca", pts: 28},
      {pos: 5, nombre: "Chivas", pts: 26},
    ];

    const tbody = document.querySelector("#tablaGeneral tbody");
    equipos.forEach(eq => {
      tbody.innerHTML += `
        <tr>
          <td>${eq.pos}</td>
          <td>${eq.nombre}</td>
          <td>${eq.pts}</td>
        </tr>`;
    });

    cargarNoticias();

    
</script>

</body>
</html>











