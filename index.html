<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiniela360 | Pronósticos Avanzado</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
    .partido { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    .equipo { font-weight: bold; }
    .opciones button { margin: 0 5px; padding: 5px 10px; cursor: pointer; }
    .opcion.selected { background: #4CAF50; color: #fff; }
    #guardar-btn { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    #contador { font-weight: bold; margin-bottom: 20px; }
    .pronosticos-anteriores { margin-top: 30px; background: #fff; padding: 10px; border-radius: 5px; }
    .pronostico-item { border-bottom: 1px solid #ccc; padding: 5px 0; }
  </style>
</head>
<body>

<h1>Quiniela360 | Pronósticos</h1>
<div id="contador">Cargando...</div>

<div id="partidos-container">
  <!-- Partidos se cargarán aquí -->
</div>

<button id="guardar-btn">Guardar Pronósticos</button>

<h2>Pronósticos Anteriores</h2>
<div class="pronosticos-anteriores" id="pronosticos-anterior-container">
  Cargando...
</div>

<script>
  // ─── Configuración Firebase ─────────────────────
  const firebaseConfig = {
    apiKey: "AIzaSyC8itN53SkagtwJPqw6XSllsUP8w7-o7d8",
  authDomain: "quiniela-hydra.firebaseapp.com",
  databaseURL: "https://quieniela-hydra-default-rtdb.firebaseio.com",
  projectId: "quiniela-hydra",
  storageBucket: "quiniela-hydra.firebasestorage.app",
  messagingSenderId: "329849216739",
  appId: "1:329849216739:web:83d23ff1424eb167172fd6",
  measurementId: "G-FWDDQ5HQYV"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const grupoId = "ID_DEL_GRUPO"; // Cambiar por el grupo real
  let currentUser = null;
  let cierreTimestamp = new Date().getTime() + 60 * 60 * 1000; // ejemplo: 1 hora para cierre

  // ─── Autenticación ─────────────────────────────
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      console.log("Usuario autenticado:", user.uid);
      cargarPartidos();
      iniciarContador();
      cargarPronosticosAnteriores();
    } else {
      alert('Debes iniciar sesión para participar');
      window.location.href = 'login.html';
    }
  });

  // ─── Cargar partidos ───────────────────────────
  function cargarPartidos() {
    const partidos = [
      { local: "Querétaro", visitante: "Atlético San Luis" },
      { local: "América", visitante: "Chivas" },
      { local: "Toluca", visitante: "Pumas" }
    ];

    const container = document.getElementById('partidos-container');
    container.innerHTML = '';

    partidos.forEach((p, i) => {
      const div = document.createElement('div');
      div.className = 'partido';
      div.innerHTML = `
        <span class="equipo">${p.local}</span>
        <div class="opciones">
          <button class="opcion" data-result="L">L</button>
          <button class="opcion" data-result="E">E</button>
          <button class="opcion" data-result="V">V</button>
        </div>
        <span class="equipo">${p.visitante}</span>
      `;
      container.appendChild(div);
    });

    // Eventos de selección
    document.querySelectorAll('.opcion').forEach(btn => {
      btn.addEventListener('click', () => {
        const opciones = btn.parentNode.querySelectorAll('.opcion');
        opciones.forEach(o => o.classList.remove('selected'));
        btn.classList.add('selected');
      });
    });
  }

  // ─── Contador regresivo ─────────────────────────
  function iniciarContador() {
    const contadorEl = document.getElementById('contador');
    const interval = setInterval(() => {
      const now = new Date().getTime();
      const distance = cierreTimestamp - now;

      if (distance <= 0) {
        clearInterval(interval);
        contadorEl.textContent = "Cierre de pronósticos";
        document.getElementById('guardar-btn').disabled = true;
        return;
      }

      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000*60*60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000*60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      contadorEl.textContent = `Tiempo restante: ${hours}h ${minutes}m ${seconds}s`;
    }, 1000);
  }

  // ─── Guardar pronósticos ────────────────────────
  document.getElementById('guardar-btn').addEventListener('click', async () => {
    if (!currentUser) return alert('Usuario no autenticado');

    const partidos = [];
    let completo = true;

    document.querySelectorAll('.partido').forEach(partidoEl => {
      const opcion = partidoEl.querySelector('.opcion.selected');
      if (!opcion) {
        completo = false;
        partidoEl.style.border = '1px solid red';
        setTimeout(() => partidoEl.style.border = 'none', 1000);
        return;
      }
      const equipos = partidoEl.querySelectorAll('.equipo');
      partidos.push({
        local: equipos[0].textContent,
        visitante: equipos[1].textContent,
        prediccion: opcion.getAttribute('data-result')
      });
    });

    if (!completo) {
      alert('¡Debes seleccionar un resultado para todos los partidos!');
      return;
    }

    try {
      const nuevoDoc = await db.collection('grupos')
        .doc(grupoId)
        .collection('pronosticos')
        .add({
          userId: currentUser.uid,
          fecha: firebase.firestore.FieldValue.serverTimestamp(),
          partidos: partidos
        });

      alert('Pronósticos guardados correctamente!');
      cargarPronosticosAnteriores();
    } catch (error) {
      console.error(error);
      alert('Error al guardar pronósticos: ' + error.message);
    }
  });

  // ─── Cargar pronósticos anteriores ─────────────
  async function cargarPronosticosAnteriores() {
    const container = document.getElementById('pronosticos-anterior-container');
    container.innerHTML = 'Cargando...';

    try {
      const snapshot = await db.collection('grupos')
        .doc(grupoId)
        .collection('pronosticos')
        .where('userId', '==', currentUser.uid)
        .orderBy('fecha', 'desc')
        .get();

      if (snapshot.empty) {
        container.innerHTML = 'No tienes pronósticos guardados aún.';
        return;
      }

      container.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.className = 'pronostico-item';
        const fecha = data.fecha ? data.fecha.toDate().toLocaleString() : '';
        const predicciones = data.partidos.map(p => `${p.local} vs ${p.visitante}: ${p.prediccion}`).join(' | ');
        div.textContent = `${fecha} → ${predicciones}`;
        container.appendChild(div);
      });
    } catch (error) {
      console.error(error);
      container.innerHTML = 'Error al cargar pronósticos anteriores';
    }
  }
</script>

</body>
</html>

