<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resultados 360</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('https://images.unsplash.com/photo-1607414721186-5309963d7b52?q=80&w=1472&auto=format&fit=crop');
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #006847;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 10px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #logout-btn {
      background-color: #ce1126;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #logout-btn:hover { background-color: #a00d1c; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #006847; color: white; }
    .highlight { background-color: yellow !important; }
    #tablaGanadores { margin: 20px auto; border-collapse: collapse; width: 350px; }
    #tablaGanadores td, #tablaGanadores th { border: 1px solid #ccc; padding: 8px; text-align: center; }
    #tablaGanadores tr.primer-lugar { background-color: #ffe08a; font-weight: bold; }
    #tablaGanadores tr.segundo-lugar { background-color: #cfe2f3; }
  </style>
</head>
<body>
  <div class="header">
    <h2>Resultados del Grupo: <span id="grupoNombre">Cargando...</span></h2>
    <button id="logout-btn">Cerrar Sesi√≥n</button>
  </div>

  <div style="text-align:center; margin-top:20px;">
    <button onclick="window.location.href='index.html'" style="padding:10px 20px; background:#006847; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">
      ‚¨ÖÔ∏è Regresar a Pron√≥sticos
    </button>
  </div>

  <div id="premio-box" style="margin:20px auto; width:90%; max-width:600px; background:#fff; border:2px solid #006847; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center;">
    <h3 style="color:#006847;">üèÜ Premio Acumulado</h3>
    <p style="font-size:20px; color:#FFD700;">1er Lugar</p>
    <p id="premio-total" style="font-size:24px; font-weight:bold;">$0.00 MXN</p>
    <p style="font-size:18px; color:#C0C0C0;">2do Lugar: 1 Cr√©dito GRATIS</p>
    <p style="font-size:14px;">En caso de empate, el premio se divide entre los ganadores.</p>
  </div>

  <h2 style="color:#FFD700;">üèÜ Ganadores</h2>
  <table id="tablaGanadores">
    <thead>
      <tr><th>Lugar</th><th>Usuario</th><th>Total</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Resultados Oficiales</h2>
  <table>
    <thead>
      <tr>
        <th colspan="3">Ingresar Resultados</th>
        <th>P1</th><th>P2</th><th>P3</th><th>P4</th><th>P5</th>
        <th>P6</th><th>P7</th><th>P8</th><th>P9</th><th>P10</th>
      </tr>
      <tr id="input-resultados">
        <td colspan="3"></td>
        ${[...Array(10)].map((_,i)=>`<td><input type="text" maxlength="1" size="1" id="res-${i+1}"/></td>`).join("")}
      </tr>
      <tr>
        <th>Usuario</th><th>Fecha</th><th>Hora</th>
        <th>P1</th><th>P2</th><th>P3</th><th>P4</th><th>P5</th>
        <th>P6</th><th>P7</th><th>P8</th><th>P9</th><th>P10</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="resultados-body"></tbody>
  </table>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    const db = firebase.firestore();
    const params = new URLSearchParams(window.location.search);
    const grupoId = params.get("grupo") || localStorage.getItem("grupoSeleccionado");
    document.getElementById("grupoNombre").textContent = grupoId || "Sin grupo";

    async function cargarResultados() {
      if (!grupoId) return;
      const snap = await db.collection("grupos").doc(grupoId).collection("pronosticos").get();

      const totalPronosticos = snap.size;
      const montoTotal = totalPronosticos * 250; // cada entrada vale 250
      const premioFinal = montoTotal * 0.8;
      document.getElementById("premio-total").textContent = `$${premioFinal.toFixed(2)} MXN`;

      const resultadosOficiales = {};
      for (let i=1;i<=10;i++) {
        const val = document.getElementById(`res-${i}`).value.toUpperCase();
        if (["L","E","V"].includes(val)) resultadosOficiales[i]=val;
      }

      const tbody = document.getElementById("resultados-body");
      tbody.innerHTML = "";

      for (const doc of snap.docs) {
        const data = doc.data();
        const pronosticos = data.pronosticos || {};
        let nombre = data.userId;

        // traer nombre del usuario
        try {
          const userSnap = await db.collection("users").doc(data.userId).get();
          if (userSnap.exists) {
            nombre = userSnap.data().username || userSnap.data().email || nombre;
          }
        } catch(e){ console.error(e); }

        let fecha="", hora="";
        if (data.fecha && data.fecha.toDate) {
          const f = data.fecha.toDate();
          fecha=f.toLocaleDateString();
          hora=f.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
        }

        let total=0;
        const celdas=[...Array(10)].map((_,i)=>{
          const pred = pronosticos[i] || "-";
          const coincide = resultadosOficiales[i+1] && resultadosOficiales[i+1]===pred;
          if (coincide) total++;
          return `<td class="${coincide?'highlight':''}">${pred}</td>`;
        });

        const fila=document.createElement("tr");
        fila.innerHTML=`
          <td>${nombre}</td>
          <td>${fecha}</td>
          <td>${hora}</td>
          ${celdas.join("")}
          <td>${total}</td>`;
        tbody.appendChild(fila);
      }
      actualizarGanadores();
    }

    function actualizarGanadores() {
      const filas=document.querySelectorAll("#resultados-body tr");
      const datos=[];
      filas.forEach(f=>{
        const c=f.querySelectorAll("td");
        const usuario=c[0].innerText;
        const total=parseInt(c[c.length-1].innerText)||0;
        datos.push({usuario,total});
      });
      datos.sort((a,b)=>b.total-a.total);
      const tabla=document.querySelector("#tablaGanadores tbody");
      tabla.innerHTML="";
      if (datos.length===0) return;

      const max=datos[0].total;
      const segundo=datos.find(d=>d.total<max)?.total;

      datos.filter(d=>d.total===max).forEach(d=>{
        tabla.innerHTML+=`<tr class="primer-lugar"><td>ü•á 1er Lugar</td><td>${d.usuario}</td><td>${d.total}</td></tr>`;
      });
      if (segundo!==undefined) {
        datos.filter(d=>d.total===segundo).forEach(d=>{
          tabla.innerHTML+=`<tr class="segundo-lugar"><td>ü•à 2do Lugar</td><td>${d.usuario}</td><td>${d.total}</td></tr>`;
        });
      }
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      cargarResultados();
      for (let i=1;i<=10;i++) {
        document.getElementById(`res-${i}`).addEventListener("input",cargarResultados);
      }
    });

    document.getElementById("logout-btn").addEventListener("click",()=>{
      firebase.auth().signOut().then(()=>window.location.href="login.html");
    });
  </script>

  <footer style="background:#1a1a1a; color:white; padding:30px; margin-top:30px; text-align:center;">
    <h2 style="color:#00d084;">Quiniela360</h2>
    <p>Plataforma de pron√≥sticos deportivos en l√≠nea.</p>
    <p>¬© 2025 Quiniela360.com - Todos los derechos reservados.</p>
    <p style="font-size:12px;">q.h.ricardoarturo@gmail.com</p>
  </footer>
</body>
</html>
